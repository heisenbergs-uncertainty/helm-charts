apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "timescale.fullname" . }}
  labels:
    {{- include "timescale.labels" . | nindent 4 }}
spec:
  serviceName: {{ include "timescale.fullname" . }}
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "timescale.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "timescale.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "timescale.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      initContainers:
        - name: fix-permissions
          image: busybox:1.35
          command:
            - sh
            - -c
            - |
              echo "Fixing permissions on PostgreSQL data directory..."
              # Fix the data directory permissions  
              chown -R 1000:1000 /var/lib/postgresql/data
              chmod -R 755 /var/lib/postgresql/data
              echo "Permissions fixed successfully"
          securityContext:
            runAsUser: 0
            runAsGroup: 0
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 64Mi
          volumeMounts:
            - name: timescale-storage
              mountPath: /var/lib/postgresql/data
        - name: update-postgres-config
          image: busybox:1.35
          command:
            - sh
            - -c
            - |
              set -e
              CONFIG_FILE="/var/lib/postgresql/data/pgdata/postgresql.conf"
              
              # Only update config if database is already initialized
              if [ -f "$CONFIG_FILE" ]; then
                echo "Database already initialized. Updating postgresql.conf with current parameters..."
                
                # Function to update or add a parameter in postgresql.conf
                update_param() {
                  local param_name="$1"
                  local param_value="$2"
                  local config_file="$3"
                  
                  # Convert environment variable name to postgresql.conf format
                  # e.g., MAX_CONNECTIONS -> max_connections
                  local pg_param=$(echo "$param_name" | tr '[:upper:]' '[:lower:]')
                  
                  echo "  Setting $pg_param = $param_value"
                  
                  # Determine if value needs quotes (contains spaces, commas, or special chars)
                  if echo "$param_value" | grep -q '[, ]'; then
                    # Value needs quotes
                    local formatted_value="'$param_value'"
                  else
                    # No quotes needed
                    local formatted_value="$param_value"
                  fi
                  
                  # Check if parameter exists in config
                  if grep -q "^[[:space:]]*$pg_param[[:space:]]*=" "$config_file"; then
                    # Parameter exists, update it
                    sed -i "s|^[[:space:]]*$pg_param[[:space:]]*=.*|$pg_param = $formatted_value|g" "$config_file"
                  elif grep -q "^[[:space:]]*#[[:space:]]*$pg_param[[:space:]]*=" "$config_file"; then
                    # Parameter exists but is commented out, uncomment and update
                    sed -i "s|^[[:space:]]*#[[:space:]]*$pg_param[[:space:]]*=.*|$pg_param = $formatted_value|g" "$config_file"
                  else
                    # Parameter doesn't exist, append it
                    echo "$pg_param = $formatted_value" >> "$config_file"
                  fi
                }
                
                # Process all POSTGRES_CONFIG_* environment variables
                {{- range $key, $value := .Values.postgres.parameters }}
                update_param "{{ $key }}" "{{ $value }}" "$CONFIG_FILE"
                {{- end }}
                
                echo "Configuration update complete!"
              else
                echo "Database not yet initialized. Skipping config update (will be set during initdb)."
              fi
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 64Mi
          volumeMounts:
            - name: timescale-storage
              mountPath: /var/lib/postgresql/data
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: POSTGRES_USER
              value: {{ .Values.postgres.user | quote }}
            - name: POSTGRES_PASSWORD
              value: {{ .Values.postgres.password | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.postgres.database | quote }}
            - name: PGDATA
              value: {{ .Values.postgres.dataPath | quote }}
            {{- if .Values.postgres.skipAutoTune }}
            - name: TIMESCALEDB_TUNE_SKIP
              value: "true"
            {{- end }}
            {{- if .Values.monitoring.enabled }}
            {{- if .Values.postgres.monitoring.enablePgStatStatements }}
            - name: POSTGRES_INITDB_ARGS
              value: "--auth-host=md5"
            {{- end }}
            {{- if .Values.postgres.monitoring.trackIoTiming }}
            - name: POSTGRES_CONFIG_track_io_timing
              value: "on"
            {{- end }}
            {{- if .Values.postgres.monitoring.trackFunctions }}
            - name: POSTGRES_CONFIG_track_functions
              value: {{ .Values.postgres.monitoring.trackFunctions | quote }}
            {{- end }}
            {{- if .Values.postgres.monitoring.logMinDurationStatement }}
            - name: POSTGRES_CONFIG_log_min_duration_statement
              value: {{ .Values.postgres.monitoring.logMinDurationStatement | quote }}
            {{- end }}
            - name: POSTGRES_CONFIG_shared_preload_libraries
              value: "timescaledb,pg_stat_statements"
            {{- end }}
            {{- with .Values.postgres.parameters }}  # New: Inject custom parameters
            {{- range $key, $value := . }}
            - name: POSTGRES_CONFIG_{{ $key | upper }}
              value: {{ $value | quote }}
            {{- end }}
            {{- end }}
          ports:
            - name: postgresql
              containerPort: {{ .Values.postgres.port }}
              protocol: TCP
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - exec pg_isready -U "{{ .Values.postgres.user }}" -h 127.0.0.1 -p {{ .Values.postgres.port }}
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - exec pg_isready -U "{{ .Values.postgres.user }}" -h 127.0.0.1 -p {{ .Values.postgres.port }}
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          volumeMounts:
            - name: timescale-storage
              mountPath: /var/lib/postgresql/data
            {{- if .Values.shm.enabled }}
            - name: dshm
              mountPath: /dev/shm
            {{- end }}
        {{- if .Values.monitoring.enabled }}
        - name: postgres-exporter
          image: "{{ .Values.monitoring.postgresExporter.image.repository }}:{{ .Values.monitoring.postgresExporter.image.tag }}"
          imagePullPolicy: {{ .Values.monitoring.postgresExporter.image.pullPolicy }}
          env:
            - name: DATA_SOURCE_NAME
              value: "postgresql://{{ .Values.postgres.user }}:{{ .Values.postgres.password }}@localhost:{{ .Values.postgres.port }}/{{ .Values.postgres.database }}?sslmode=disable"
            - name: PG_EXPORTER_WEB_LISTEN_ADDRESS
              value: ":{{ .Values.monitoring.postgresExporter.port }}"
            - name: PG_EXPORTER_EXTEND_QUERY_PATH
              value: "/etc/postgres_exporter/queries.yaml"
          ports:
            - name: metrics
              containerPort: {{ .Values.monitoring.postgresExporter.port }}
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: metrics
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: metrics
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            {{- toYaml .Values.monitoring.postgresExporter.resources | nindent 12 }}
          volumeMounts:
            - name: postgres-exporter-config
              mountPath: /etc/postgres_exporter
              readOnly: true
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      volumes:
        {{- if .Values.persistence.enabled }}
        - name: timescale-storage
          persistentVolumeClaim:
            claimName: {{ include "timescale.pvcName" . }}
        {{- else }}
        - name: timescale-storage
          emptyDir: {}
        {{- end }}
        {{- if .Values.shm.enabled }}
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: {{ .Values.shm.size }}
        {{- end }}
        {{- if .Values.monitoring.enabled }}
        - name: postgres-exporter-config
          configMap:
            name: {{ include "timescale.fullname" . }}-postgres-exporter-config
        {{- end }}
